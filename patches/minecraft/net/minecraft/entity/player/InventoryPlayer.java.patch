--- ../src-base/minecraft/net/minecraft/entity/player/InventoryPlayer.java
+++ ../src-work/minecraft/net/minecraft/entity/player/InventoryPlayer.java
@@ -1,5 +1,6 @@
 package net.minecraft.entity.player;
 
+import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Iterator;
 import java.util.List;
@@ -9,6 +10,7 @@
 import net.minecraft.crash.CrashReportCategory;
 import net.minecraft.crash.ICrashReportDetail;
 import net.minecraft.inventory.IInventory;
+import net.minecraft.inventory.InventoryBasic;
 import net.minecraft.inventory.ItemStackHelper;
 import net.minecraft.item.Item;
 import net.minecraft.item.ItemArmor;
@@ -23,8 +25,11 @@
 import net.minecraft.util.text.TextComponentTranslation;
 import net.minecraftforge.fml.relauncher.Side;
 import net.minecraftforge.fml.relauncher.SideOnly;
+import org.bukkit.Location;
+import org.bukkit.craftbukkit.entity.CraftHumanEntity;
+import org.bukkit.entity.HumanEntity;
 
-public class InventoryPlayer implements IInventory
+public class InventoryPlayer extends InventoryBasic implements IInventory
 {
     public final NonNullList<ItemStack> field_70462_a = NonNullList.<ItemStack>func_191197_a(36, ItemStack.field_190927_a);
     public final NonNullList<ItemStack> field_70460_b = NonNullList.<ItemStack>func_191197_a(4, ItemStack.field_190927_a);
@@ -34,9 +39,63 @@
     public EntityPlayer field_70458_d;
     private ItemStack field_70457_g;
     public boolean field_70459_e;
+    // CraftBukkit start - add fields and methods
+    public List<HumanEntity> transaction = new ArrayList<HumanEntity>();
+    private int maxStack = 64;
 
+    public List<ItemStack> getContents() {
+        List<ItemStack> combined = new ArrayList<ItemStack>(field_70462_a.size() + field_70460_b.size() + field_184439_c.size());
+        for (List<ItemStack> sub : this.field_184440_g) {
+            combined.addAll(sub);
+        }
+
+        return combined;
+    }
+
+    public List<ItemStack> getArmorContents() {
+        return this.field_70460_b;
+    }
+
+    public void onOpen(CraftHumanEntity who) {
+        transaction.add(who);
+    }
+
+    public void onClose(CraftHumanEntity who) {
+        transaction.remove(who);
+    }
+
+    public List<HumanEntity> getViewers() {
+        return transaction;
+    }
+
+    public org.bukkit.inventory.InventoryHolder getOwner() {
+        return this.field_70458_d.getBukkitEntity();
+    }
+
+    public void setMaxStackSize(int size) {
+        maxStack = size;
+    }
+
+    // CraftBukkit end
+    // CraftBukkit start - Watch method above! :D
+    public int canHold(ItemStack itemstack) {
+        int remains = itemstack.func_190916_E();
+        for (int i = 0; i < this.field_70462_a.size(); ++i) {
+            ItemStack itemstack1 = this.func_70301_a(i);
+            if (itemstack1.func_190926_b()) return itemstack.func_190916_E();
+
+            // Taken from firstPartial(ItemStack)
+            if (!itemstack1.func_190926_b() && itemstack1.func_77973_b() == itemstack.func_77973_b() && itemstack1.func_77985_e() && itemstack1.func_190916_E() < itemstack1.func_77976_d() && itemstack1.func_190916_E() < this.func_70297_j_() && (!itemstack1.func_77981_g() || itemstack1.func_77960_j() == itemstack.func_77960_j()) && ItemStack.func_77970_a(itemstack1, itemstack)) {
+                remains -= (itemstack1.func_77976_d() < this.func_70297_j_() ? itemstack1.func_77976_d() : this.func_70297_j_()) - itemstack1.func_190916_E();
+            }
+            if (remains <= 0) return itemstack.func_190916_E();
+        }
+        return itemstack.func_190916_E() - remains;
+    }
+    // CraftBukkit end
     public InventoryPlayer(EntityPlayer p_i1750_1_)
     {
+        super(p_i1750_1_.func_70005_c_(),true,41);
         this.field_184440_g = Arrays.<NonNullList<ItemStack>>asList(new NonNullList[] {this.field_70462_a, this.field_70460_b, this.field_184439_c});
         this.field_70457_g = ItemStack.field_190927_a;
         this.field_70458_d = p_i1750_1_;
@@ -275,7 +334,8 @@
 
             if (itemstack.func_190926_b())
             {
-                itemstack = new ItemStack(item, 0, p_70452_1_.func_77960_j());
+                itemstack = p_70452_1_.func_77946_l(); // Forge: Replace Item clone above to preserve item capabilities when picking the item up.
+                itemstack.func_190920_e(0);
 
                 if (p_70452_1_.func_77942_o())
                 {
@@ -347,6 +407,14 @@
                 }
             }
         }
+
+        for (ItemStack is : field_70460_b) // FORGE: Tick armor on animation ticks
+        {
+            if (!is.func_190926_b())
+            {
+                is.func_77973_b().onArmorTick(field_70458_d.field_70170_p, field_70458_d, is);
+            }
+        }
     }
 
     public boolean func_70441_a(final ItemStack p_70441_1_)
