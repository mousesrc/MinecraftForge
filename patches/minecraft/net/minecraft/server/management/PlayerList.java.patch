--- ../src-base/minecraft/net/minecraft/server/management/PlayerList.java
+++ ../src-work/minecraft/net/minecraft/server/management/PlayerList.java
@@ -1,5 +1,7 @@
 package net.minecraft.server.management;
 
+import com.google.common.base.Predicate;
+import com.google.common.collect.Iterables;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
 import com.google.common.collect.Sets;
@@ -52,6 +54,7 @@
 import net.minecraft.util.text.TextComponentTranslation;
 import net.minecraft.util.text.TextFormatting;
 import net.minecraft.world.GameType;
+import net.minecraft.world.Teleporter;
 import net.minecraft.world.World;
 import net.minecraft.world.WorldServer;
 import net.minecraft.world.border.IBorderListener;
@@ -60,10 +63,20 @@
 import net.minecraft.world.demo.DemoWorldManager;
 import net.minecraft.world.storage.IPlayerFileData;
 import net.minecraft.world.storage.WorldInfo;
+import net.minecraftforge.common.DimensionManager;
 import net.minecraftforge.fml.relauncher.Side;
 import net.minecraftforge.fml.relauncher.SideOnly;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.Bukkit;
+import org.bukkit.Location;
+import org.bukkit.Server;
+import org.bukkit.craftbukkit.CraftServer;
+import org.bukkit.entity.Player;
+import org.bukkit.event.Event;
+import org.bukkit.event.player.PlayerRespawnEvent;
+import org.bukkit.event.player.PlayerTeleportEvent;
+import org.spigotmc.SpigotConfig;
 
 public abstract class PlayerList
 {
@@ -89,8 +102,15 @@
     private boolean field_72407_n;
     private int field_72408_o;
 
-    public PlayerList(MinecraftServer p_i1500_1_)
-    {
+    // CraftBukkit start
+    private CraftServer cserver;
+
+    public PlayerList(MinecraftServer p_i1500_1_) {
+        this.cserver = p_i1500_1_.server = new CraftServer(p_i1500_1_, this);
+        SpigotConfig.init(new File("spigot.yml"));
+        p_i1500_1_.console = org.bukkit.craftbukkit.command.ColouredConsoleSender.getInstance();
+        p_i1500_1_.reader.addCompleter(new org.bukkit.craftbukkit.command.ConsoleCommandCompleter(p_i1500_1_.server));
+        // CraftBukkit end
         this.field_72401_g = new UserListBans(field_152613_a);
         this.field_72413_h = new UserListIPBans(field_152614_b);
         this.field_72414_i = new UserListOps(field_152615_c);
@@ -102,7 +122,7 @@
         this.field_72405_c = 8;
     }
 
-    public void func_72355_a(NetworkManager p_72355_1_, EntityPlayerMP p_72355_2_)
+    public void initializeConnectionToPlayer(NetworkManager p_72355_1_, EntityPlayerMP p_72355_2_, NetHandlerPlayServer nethandlerplayserver)
     {
         GameProfile gameprofile = p_72355_2_.func_146103_bH();
         PlayerProfileCache playerprofilecache = this.field_72400_f.func_152358_ax();
@@ -111,6 +131,17 @@
         playerprofilecache.func_152649_a(gameprofile);
         NBTTagCompound nbttagcompound = this.func_72380_a(p_72355_2_);
         p_72355_2_.func_70029_a(this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK));
+
+        World playerWorld = this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK);
+        if (playerWorld == null)
+        {
+            p_72355_2_.field_71093_bK = 0;
+            playerWorld = this.field_72400_f.func_71218_a(0);
+            BlockPos spawnPoint = playerWorld.field_73011_w.getRandomizedSpawnPoint();
+            p_72355_2_.func_70107_b(spawnPoint.func_177958_n(), spawnPoint.func_177956_o(), spawnPoint.func_177952_p());
+        }
+
+        p_72355_2_.func_70029_a(playerWorld);
         p_72355_2_.field_71134_c.func_73080_a((WorldServer)p_72355_2_.field_70170_p);
         String s1 = "local";
 
@@ -119,12 +150,12 @@
             s1 = p_72355_1_.func_74430_c().toString();
         }
 
-        field_148546_d.info("{}[{}] logged in with entity id {} at ({}, {}, {})", new Object[] {p_72355_2_.func_70005_c_(), s1, Integer.valueOf(p_72355_2_.func_145782_y()), Double.valueOf(p_72355_2_.field_70165_t), Double.valueOf(p_72355_2_.field_70163_u), Double.valueOf(p_72355_2_.field_70161_v)});
+        field_148546_d.info("{}[{}] logged in with entity id {} at ({}, {}, {}) in Dimension -> {}", new Object[] {p_72355_2_.func_70005_c_(), s1, Integer.valueOf(p_72355_2_.func_145782_y()), Double.valueOf(p_72355_2_.field_70165_t), Double.valueOf(p_72355_2_.field_70163_u), Double.valueOf(p_72355_2_.field_70161_v),p_72355_2_.func_71121_q().dimension});
         WorldServer worldserver = this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK);
         WorldInfo worldinfo = worldserver.func_72912_H();
         this.func_72381_a(p_72355_2_, (EntityPlayerMP)null, worldserver);
-        NetHandlerPlayServer nethandlerplayserver = new NetHandlerPlayServer(this.field_72400_f, p_72355_1_, p_72355_2_);
-        nethandlerplayserver.func_147359_a(new SPacketJoinGame(p_72355_2_.func_145782_y(), p_72355_2_.field_71134_c.func_73081_b(), worldinfo.func_76093_s(), worldserver.field_73011_w.func_186058_p().func_186068_a(), worldserver.func_175659_aa(), this.func_72352_l(), worldinfo.func_76067_t(), worldserver.func_82736_K().func_82766_b("reducedDebugInfo")));
+        p_72355_2_.field_71135_a = nethandlerplayserver;
+        nethandlerplayserver.func_147359_a(new SPacketJoinGame(p_72355_2_.func_145782_y(), p_72355_2_.field_71134_c.func_73081_b(), worldinfo.func_76093_s(), worldserver.field_73011_w.getDimension(), worldserver.func_175659_aa(), this.func_72352_l(), worldinfo.func_76067_t(), worldserver.func_82736_K().func_82766_b("reducedDebugInfo")));
         nethandlerplayserver.func_147359_a(new SPacketCustomPayload("MC|Brand", (new PacketBuffer(Unpooled.buffer())).func_180714_a(this.func_72365_p().getServerModName())));
         nethandlerplayserver.func_147359_a(new SPacketServerDifficulty(worldinfo.func_176130_y(), worldinfo.func_176123_z()));
         nethandlerplayserver.func_147359_a(new SPacketPlayerAbilities(p_72355_2_.field_71075_bZ));
@@ -200,6 +231,7 @@
         }
 
         p_72355_2_.func_71116_b();
+        net.minecraftforge.fml.common.FMLCommonHandler.instance().firePlayerLoggedIn(p_72355_2_);
     }
 
     public void func_96456_a(ServerScoreboard p_96456_1_, EntityPlayerMP p_96456_2_)
@@ -290,6 +322,7 @@
             nbttagcompound1 = this.field_72400_f.func_184110_aI().func_188257_a(FixTypes.PLAYER, nbttagcompound);
             p_72380_1_.func_70020_e(nbttagcompound1);
             field_148546_d.debug("loading single player");
+            net.minecraftforge.event.ForgeEventFactory.firePlayerLoadingEvent(p_72380_1_, this.field_72412_k, p_72380_1_.func_110124_au().toString());
         }
         else
         {
@@ -299,8 +332,24 @@
         return nbttagcompound1;
     }
 
+    public NBTTagCompound getPlayerNBT(EntityPlayerMP player)
+    {
+        // Hacky method to allow loading the NBT for a player prior to login
+        NBTTagCompound nbttagcompound = this.field_72400_f.field_71305_c[0].func_72912_H().func_76072_h();
+        if (player.func_70005_c_().equals(this.field_72400_f.func_71214_G()) && nbttagcompound != null)
+        {
+            return nbttagcompound;
+        }
+        else
+        {
+            return ((net.minecraft.world.storage.SaveHandler)this.field_72412_k).getPlayerNBT(player);
+        }
+    }
+
     protected void func_72391_b(EntityPlayerMP p_72391_1_)
     {
+        if (p_72391_1_.field_71135_a == null) return;
+
         this.field_72412_k.func_75753_a(p_72391_1_);
         StatisticsManagerServer statisticsmanagerserver = (StatisticsManagerServer)this.field_148547_k.get(p_72391_1_.func_110124_au());
 
@@ -322,6 +371,7 @@
             p_72377_1_.field_71135_a.func_147359_a(new SPacketPlayerListItem(SPacketPlayerListItem.Action.ADD_PLAYER, new EntityPlayerMP[] {(EntityPlayerMP)this.field_72404_b.get(i)}));
         }
 
+        net.minecraftforge.common.chunkio.ChunkIOExecutor.adjustPoolSize(this.func_72394_k());
         worldserver.func_72838_d(p_72377_1_);
         this.func_72375_a(p_72377_1_, (WorldServer)null);
     }
@@ -333,6 +383,7 @@
 
     public void func_72367_e(EntityPlayerMP p_72367_1_)
     {
+        net.minecraftforge.fml.common.FMLCommonHandler.instance().firePlayerLoggedOut(p_72367_1_);
         WorldServer worldserver = p_72367_1_.func_71121_q();
         p_72367_1_.func_71029_a(StatList.field_75947_j);
         this.func_72391_b(p_72367_1_);
@@ -367,6 +418,7 @@
             this.field_177454_f.remove(uuid);
             this.field_148547_k.remove(uuid);
         }
+        net.minecraftforge.common.chunkio.ChunkIOExecutor.adjustPoolSize(this.func_72394_k());
 
         this.func_148540_a(new SPacketPlayerListItem(SPacketPlayerListItem.Action.REMOVE_PLAYER, new EntityPlayerMP[] {p_72367_1_}));
     }
@@ -450,13 +502,31 @@
 
     public EntityPlayerMP func_72368_a(EntityPlayerMP p_72368_1_, int p_72368_2_, boolean p_72368_3_)
     {
+        //final phase of tp
+        //recreate the entity on teleporting
+        //or recreate entity on respawn
+        //dimension param means target dim
+        Location old = new Location(DimensionManager.getWorld(p_72368_2_).getWorld(),p_72368_1_.func_180425_c().func_177958_n(),p_72368_1_.func_180425_c().func_177956_o(),p_72368_1_.func_180425_c().func_177952_p());
+        Location newpos;
+        World world = field_72400_f.func_71218_a(p_72368_2_);
+        if (world == null) //no such dim,fallingback to worldspawn
+        {
+            p_72368_2_ = p_72368_1_.getSpawnDimension();
+        }
+        else if (!world.field_73011_w.func_76567_e())  //cannot respawn in nether
+        {
+            p_72368_2_ = world.field_73011_w.getRespawnDimension(p_72368_1_);
+        }
+        if (field_72400_f.func_71218_a(p_72368_2_) == null) p_72368_2_ = 0;
+
         p_72368_1_.func_71121_q().func_73039_n().func_72787_a(p_72368_1_);
         p_72368_1_.func_71121_q().func_73039_n().func_72790_b(p_72368_1_);
         p_72368_1_.func_71121_q().func_184164_w().func_72695_c(p_72368_1_);
         this.field_72404_b.remove(p_72368_1_);
+        //entity was removed here
         this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK).func_72973_f(p_72368_1_);
-        BlockPos blockpos = p_72368_1_.func_180470_cg();
-        boolean flag = p_72368_1_.func_82245_bX();
+        BlockPos old_bedloc = p_72368_1_.getBedLocation(p_72368_2_);  //your bed location in last world
+        boolean flag = p_72368_1_.isSpawnForced(p_72368_2_);
         p_72368_1_.field_71093_bK = p_72368_2_;
         PlayerInteractionManager playerinteractionmanager;
 
@@ -468,10 +538,12 @@
         {
             playerinteractionmanager = new PlayerInteractionManager(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK));
         }
+        //recreate entity in new world
 
         EntityPlayerMP entityplayermp = new EntityPlayerMP(this.field_72400_f, this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK), p_72368_1_.func_146103_bH(), playerinteractionmanager);
         entityplayermp.field_71135_a = p_72368_1_.field_71135_a;
         entityplayermp.func_71049_a(p_72368_1_, p_72368_3_);
+        entityplayermp.field_71093_bK = p_72368_2_;
         entityplayermp.func_145769_d(p_72368_1_.func_145782_y());
         entityplayermp.func_174817_o(p_72368_1_);
         entityplayermp.func_184819_a(p_72368_1_.func_184591_cq());
@@ -483,26 +555,32 @@
 
         WorldServer worldserver = this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK);
         this.func_72381_a(entityplayermp, p_72368_1_, worldserver);
-
-        if (blockpos != null)
+        boolean isBedRespawn = false; //MCPCRevive : tosend event
+        if (old_bedloc != null)   //blockpos1 :
         {
-            BlockPos blockpos1 = EntityPlayer.func_180467_a(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK), blockpos, flag);
+            //blockpos2 the bed location here
+            BlockPos new_bedloc = EntityPlayer.func_180467_a(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK), old_bedloc, flag);
 
-            if (blockpos1 != null)
+            if (new_bedloc != null)
             {
-                entityplayermp.func_70012_b((double)((float)blockpos1.func_177958_n() + 0.5F), (double)((float)blockpos1.func_177956_o() + 0.1F), (double)((float)blockpos1.func_177952_p() + 0.5F), 0.0F, 0.0F);
-                entityplayermp.func_180473_a(blockpos, flag);
+                //if we got bed location in this world ,set spawnpoint, and respawn in the bed
+                isBedRespawn = true;
+                newpos = new Location(DimensionManager.getWorld(p_72368_1_.field_71093_bK).getWorld(),new_bedloc.func_177958_n() + 0.5F, new_bedloc.func_177956_o() + 0.1F,new_bedloc.func_177952_p() + 0.5F);
+                entityplayermp.func_70012_b((double)((float)new_bedloc.func_177958_n() + 0.5F), (double)((float)new_bedloc.func_177956_o() + 0.1F), (double)((float)new_bedloc.func_177952_p() + 0.5F), 0.0F, 0.0F);
+                entityplayermp.func_180473_a(old_bedloc, flag);
+                
             }
             else
             {
                 entityplayermp.field_71135_a.func_147359_a(new SPacketChangeGameState(0, 0.0F));
             }
         }
-
+        
         worldserver.func_72863_F().func_186025_d((int)entityplayermp.field_70165_t >> 4, (int)entityplayermp.field_70161_v >> 4);
 
         while (!worldserver.func_184144_a(entityplayermp, entityplayermp.func_174813_aQ()).isEmpty() && entityplayermp.field_70163_u < 256.0D)
         {
+            //if the respawn point is valid
             entityplayermp.func_70107_b(entityplayermp.field_70165_t, entityplayermp.field_70163_u + 1.0D, entityplayermp.field_70161_v);
         }
 
@@ -515,10 +593,15 @@
         this.func_187243_f(entityplayermp);
         worldserver.func_184164_w().func_72683_a(entityplayermp);
         worldserver.func_72838_d(entityplayermp);
+        //MCPCRevive : fire event
+        PlayerRespawnEvent event = new PlayerRespawnEvent(cserver.getPlayer(entityplayermp),new Location(worldserver.getWorld(),entityplayermp.func_180425_c().func_177958_n(),entityplayermp.func_180425_c().func_177956_o(),entityplayermp.func_180425_c().func_177952_p()),isBedRespawn);
+        Bukkit.getServer().getPluginManager().callEvent(event);
+        //MCPCRevive end
         this.field_72404_b.add(entityplayermp);
         this.field_177454_f.put(entityplayermp.func_110124_au(), entityplayermp);
         entityplayermp.func_71116_b();
         entityplayermp.func_70606_j(entityplayermp.func_110143_aJ());
+        net.minecraftforge.fml.common.FMLCommonHandler.instance().firePlayerRespawnEvent(entityplayermp, p_72368_3_);
         return entityplayermp;
     }
 
@@ -533,15 +616,32 @@
 
     public void func_187242_a(EntityPlayerMP p_187242_1_, int p_187242_2_)
     {
+        transferPlayerToDimension(p_187242_1_, p_187242_2_, field_72400_f.func_71218_a(p_187242_2_).func_85176_s());
+    }
+
+    public void transferPlayerToDimension(EntityPlayerMP p_187242_1_, int p_187242_2_, net.minecraft.world.Teleporter teleporter)
+    {
         int i = p_187242_1_.field_71093_bK;
         WorldServer worldserver = this.field_72400_f.func_71218_a(p_187242_1_.field_71093_bK);
         p_187242_1_.field_71093_bK = p_187242_2_;
         WorldServer worldserver1 = this.field_72400_f.func_71218_a(p_187242_1_.field_71093_bK);
-        p_187242_1_.field_71135_a.func_147359_a(new SPacketRespawn(p_187242_1_.field_71093_bK, p_187242_1_.field_70170_p.func_175659_aa(), p_187242_1_.field_70170_p.func_72912_H().func_76067_t(), p_187242_1_.field_71134_c.func_73081_b()));
+        //Teleport inject here
+        //cplit get teleport target
+        BlockPos target = getTeleportTarget(p_187242_1_,i,worldserver,worldserver1);
+        Location srcLoc= new Location(worldserver.getWorld(),p_187242_1_.func_180425_c().func_177958_n(),p_187242_1_.func_180425_c().func_177956_o(),p_187242_1_.func_180425_c().func_177952_p());
+        Location targetLoc = new Location(worldserver1.getWorld(),target.func_177958_n(),target.func_177956_o(),target.func_177952_p());
+        PlayerTeleportEvent event = new PlayerTeleportEvent(cserver.getPlayer(p_187242_1_),srcLoc,targetLoc);
+        Bukkit.getServer().getPluginManager().callEvent(event);
+        if (event.isCancelled() || event.getTo() == null) {
+            return;
+        }
+        //
+        p_187242_1_.field_71135_a.func_147359_a(new SPacketRespawn(p_187242_1_.field_71093_bK, worldserver1.func_175659_aa(), worldserver1.func_72912_H().func_76067_t(), p_187242_1_.field_71134_c.func_73081_b()));
         this.func_187243_f(p_187242_1_);
         worldserver.func_72973_f(p_187242_1_);
         p_187242_1_.field_70128_L = false;
-        this.func_82448_a(p_187242_1_, i, worldserver, worldserver1);
+        //then transfer
+        this.transferEntityToWorld(p_187242_1_, worldserver, worldserver1, teleporter,target);
         this.func_72375_a(p_187242_1_, worldserver);
         p_187242_1_.field_71135_a.func_147364_a(p_187242_1_.field_70165_t, p_187242_1_.field_70163_u, p_187242_1_.field_70161_v, p_187242_1_.field_70177_z, p_187242_1_.field_70125_A);
         p_187242_1_.field_71134_c.func_73080_a(worldserver1);
@@ -553,17 +653,106 @@
         {
             p_187242_1_.field_71135_a.func_147359_a(new SPacketEntityEffect(p_187242_1_.func_145782_y(), potioneffect));
         }
+        net.minecraftforge.fml.common.FMLCommonHandler.instance().firePlayerChangedDimensionEvent(p_187242_1_, i, p_187242_2_);
     }
 
     public void func_82448_a(Entity p_82448_1_, int p_82448_2_, WorldServer p_82448_3_, WorldServer p_82448_4_)
     {
-        double d0 = p_82448_1_.field_70165_t;
-        double d1 = p_82448_1_.field_70161_v;
+        transferEntityToWorld(p_82448_1_, p_82448_2_, p_82448_3_, p_82448_4_, p_82448_4_.func_85176_s());
+    }
+    public BlockPos getTeleportTarget(Entity entityIn, int lastDimension, WorldServer oldWorldIn, WorldServer toWorldIn)
+    {
+        net.minecraft.world.WorldProvider pOld = oldWorldIn.field_73011_w;
+        net.minecraft.world.WorldProvider pNew = toWorldIn.field_73011_w;
+        double moveFactor = pOld.getMovementFactor() / pNew.getMovementFactor();
+        double d0 = entityIn.field_70165_t * moveFactor;
+        double d1 = entityIn.field_70161_v * moveFactor;
         double d2 = 8.0D;
+        //float f = entityIn.rotationYaw;
+        //oldWorldIn.theProfiler.startSection("moving");
+
+        if (false && entityIn.field_71093_bK == -1)
+        {
+            d0 = MathHelper.func_151237_a(d0 / 8.0D, toWorldIn.func_175723_af().func_177726_b() + 16.0D, toWorldIn.func_175723_af().func_177728_d() - 16.0D);
+            d1 = MathHelper.func_151237_a(d1 / 8.0D, toWorldIn.func_175723_af().func_177736_c() + 16.0D, toWorldIn.func_175723_af().func_177733_e() - 16.0D);
+            //entityIn.setLocationAndAngles(d0, entityIn.posY, d1, entityIn.rotationYaw, entityIn.rotationPitch);
+
+            //if (entityIn.isEntityAlive())
+           // {
+            //    oldWorldIn.updateEntityWithOptionalForce(entityIn, false);
+          //  }
+        }
+        else if (false && entityIn.field_71093_bK == 0)
+        {
+            d0 = MathHelper.func_151237_a(d0 * 8.0D, toWorldIn.func_175723_af().func_177726_b() + 16.0D, toWorldIn.func_175723_af().func_177728_d() - 16.0D);
+            d1 = MathHelper.func_151237_a(d1 * 8.0D, toWorldIn.func_175723_af().func_177736_c() + 16.0D, toWorldIn.func_175723_af().func_177733_e() - 16.0D);
+          //  entityIn.setLocationAndAngles(d0, entityIn.posY, d1, entityIn.rotationYaw, entityIn.rotationPitch);
+
+         //   if (entityIn.isEntityAlive())
+         ////   {
+           //     oldWorldIn.updateEntityWithOptionalForce(entityIn, false);
+         //   }
+        }
+        return new BlockPos(d0,d2,d1);
+    }
+    public void transferEntityToWorld(Entity entityIn, WorldServer oldWorldIn, WorldServer toWorldIn, net.minecraft.world.Teleporter teleporter,BlockPos targetPos)
+    {
+
+        if (entityIn.field_71093_bK == 1)
+        {
+            BlockPos blockpos;
+
+            if (oldWorldIn.field_73011_w.getDimension() == 1)
+            {
+                blockpos = toWorldIn.func_175694_M();
+            }
+            else
+            {
+                blockpos = toWorldIn.func_180504_m();
+            }
+
+
+            entityIn.field_70163_u = (double)blockpos.func_177956_o();
+            entityIn.func_70012_b(targetPos.func_177958_n(), entityIn.field_70163_u, targetPos.func_177952_p(), 90.0F, 0.0F);
+
+            if (entityIn.func_70089_S())
+            {
+                oldWorldIn.func_72866_a(entityIn, false);
+            }
+        }
+        else
+        {
+            oldWorldIn.field_72984_F.func_76320_a("placing");
+            double d0 = (double)MathHelper.func_76125_a((int)targetPos.func_177958_n(), -29999872, 29999872);
+            double d1 = (double)MathHelper.func_76125_a((int)targetPos.func_177952_p(), -29999872, 29999872);
+
+            if (entityIn.func_70089_S())
+            {
+                entityIn.func_70012_b(d0, entityIn.field_70163_u, d1, entityIn.field_70177_z, entityIn.field_70125_A);
+                teleporter.func_180266_a(entityIn, entityIn.field_70177_z);
+                toWorldIn.func_72838_d(entityIn);
+                toWorldIn.func_72866_a(entityIn, false);
+            }
+
+            oldWorldIn.field_72984_F.func_76319_b();
+        }
+        oldWorldIn.field_72984_F.func_76319_b();
+
+        entityIn.func_70029_a(toWorldIn);
+    }
+    @SuppressWarnings("unused")
+    public void transferEntityToWorld(Entity p_82448_1_, int p_82448_2_, WorldServer p_82448_3_, WorldServer p_82448_4_, net.minecraft.world.Teleporter teleporter)
+    {
+        net.minecraft.world.WorldProvider pOld = p_82448_3_.field_73011_w;
+        net.minecraft.world.WorldProvider pNew = p_82448_4_.field_73011_w;
+        double moveFactor = pOld.getMovementFactor() / pNew.getMovementFactor();
+        double d0 = p_82448_1_.field_70165_t * moveFactor;
+        double d1 = p_82448_1_.field_70161_v * moveFactor;
+        double d2 = 8.0D;
         float f = p_82448_1_.field_70177_z;
         p_82448_3_.field_72984_F.func_76320_a("moving");
 
-        if (p_82448_1_.field_71093_bK == -1)
+        if (false && p_82448_1_.field_71093_bK == -1)
         {
             d0 = MathHelper.func_151237_a(d0 / 8.0D, p_82448_4_.func_175723_af().func_177726_b() + 16.0D, p_82448_4_.func_175723_af().func_177728_d() - 16.0D);
             d1 = MathHelper.func_151237_a(d1 / 8.0D, p_82448_4_.func_175723_af().func_177736_c() + 16.0D, p_82448_4_.func_175723_af().func_177733_e() - 16.0D);
@@ -574,7 +763,7 @@
                 p_82448_3_.func_72866_a(p_82448_1_, false);
             }
         }
-        else if (p_82448_1_.field_71093_bK == 0)
+        else if (false && p_82448_1_.field_71093_bK == 0)
         {
             d0 = MathHelper.func_151237_a(d0 * 8.0D, p_82448_4_.func_175723_af().func_177726_b() + 16.0D, p_82448_4_.func_175723_af().func_177728_d() - 16.0D);
             d1 = MathHelper.func_151237_a(d1 * 8.0D, p_82448_4_.func_175723_af().func_177736_c() + 16.0D, p_82448_4_.func_175723_af().func_177733_e() - 16.0D);
@@ -585,7 +774,8 @@
                 p_82448_3_.func_72866_a(p_82448_1_, false);
             }
         }
-        else
+
+        if (p_82448_1_.field_71093_bK == 1)
         {
             BlockPos blockpos;
 
@@ -620,7 +810,7 @@
             if (p_82448_1_.func_70089_S())
             {
                 p_82448_1_.func_70012_b(d0, p_82448_1_.field_70163_u, d1, p_82448_1_.field_70177_z, p_82448_1_.field_70125_A);
-                p_82448_4_.func_85176_s().func_180266_a(p_82448_1_, f);
+                teleporter.func_180266_a(p_82448_1_, f);
                 p_82448_4_.func_72838_d(p_82448_1_);
                 p_82448_4_.func_72866_a(p_82448_1_, false);
             }
@@ -635,11 +825,40 @@
     {
         if (++this.field_72408_o > 600)
         {
-            this.func_148540_a(new SPacketPlayerListItem(SPacketPlayerListItem.Action.UPDATE_LATENCY, this.field_72404_b));
+            // CraftBukkit start
+            for (int i = 0; i < this.field_72404_b.size(); ++i) {
+                final EntityPlayerMP target = (EntityPlayerMP) this.field_72404_b.get(i);
+
+                target.field_71135_a.func_147359_a(new SPacketPlayerListItem(SPacketPlayerListItem.Action.UPDATE_LATENCY, Iterables.filter(this.field_72404_b, new Predicate<EntityPlayerMP>() {
+                    @Override
+                    public boolean apply(EntityPlayerMP input) {
+                        return ((Player)target.getBukkitEntity()).canSee((Player) input.getBukkitEntity());
+                    }
+                })));
+            }
+            // CraftBukkit end
             this.field_72408_o = 0;
         }
     }
+    // CraftBukkit start - add a world/entity limited version
+    public void sendAll(Packet packet, EntityPlayer entityhuman) {
+        for (int i = 0; i < this.field_72404_b.size(); ++i) {
+            EntityPlayerMP entityplayer =  this.field_72404_b.get(i);
+            if (entityhuman != null && entityhuman instanceof EntityPlayerMP && !((Player)entityplayer.getBukkitEntity()).canSee((Player) ((EntityPlayerMP) entityhuman).getBukkitEntity())) {
+                continue;
+            }
+            ((EntityPlayerMP) this.field_72404_b.get(i)).field_71135_a.func_147359_a(packet);
+        }
+    }
 
+    public void sendAll(Packet packet, World world) {
+        for (int i = 0; i < world.field_73010_i.size(); ++i) {
+            ((EntityPlayerMP) world.field_73010_i.get(i)).field_71135_a.func_147359_a(packet);
+        }
+
+    }
+    // CraftBukkit end
+
     public void func_148540_a(Packet<?> p_148540_1_)
     {
         for (int i = 0; i < this.field_72404_b.size(); ++i)
@@ -762,6 +981,12 @@
     {
         int i = this.field_72400_f.func_110455_j();
         this.field_72414_i.func_152687_a(new UserListOpsEntry(p_152605_1_, this.field_72400_f.func_110455_j(), this.field_72414_i.func_183026_b(p_152605_1_)));
+        // CraftBukkit start
+        Player player = field_72400_f.server.getPlayer(p_152605_1_.getId());
+        if (player != null) {
+            player.recalculatePermissions();
+        }
+        // CraftBukkit end
         this.func_187245_a(this.func_177451_a(p_152605_1_.getId()), i);
     }
 
@@ -769,6 +994,12 @@
     {
         this.field_72414_i.func_152684_c(p_152610_1_);
         this.func_187245_a(this.func_177451_a(p_152610_1_.getId()), 0);
+        // CraftBukkit start
+        Player player = field_72400_f.server.getPlayer(p_152610_1_.getId());
+        if (player != null) {
+            player.recalculatePermissions();
+        }
+        // CraftBukkit end
     }
 
     private void func_187245_a(EntityPlayerMP p_187245_1_, int p_187245_2_)
@@ -981,12 +1212,19 @@
 
     public void func_72392_r()
     {
-        for (int i = 0; i < this.field_72404_b.size(); ++i)
-        {
-            ((EntityPlayerMP)this.field_72404_b.get(i)).field_71135_a.func_147360_c("Server closed");
+        // CraftBukkit start - disconnect safely
+        for (EntityPlayerMP player : this.field_72404_b) {
+            player.field_71135_a.func_147360_c(this.field_72400_f.server.getShutdownMessage()); // CraftBukkit - add custom shutdown message
         }
+        // CraftBukkit end
     }
-
+    // CraftBukkit start
+    public void sendMessage(ITextComponent[] iChatBaseComponents) {
+        for (ITextComponent component : iChatBaseComponents) {
+            func_148544_a(component, true);
+        }
+    }
+    // CraftBukkit end
     public void func_148544_a(ITextComponent p_148544_1_, boolean p_148544_2_)
     {
         this.field_72400_f.func_145747_a(p_148544_1_);
